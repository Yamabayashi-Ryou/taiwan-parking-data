name: Update Taiwan Parking Data

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # 每 6 小時更新

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create folders
        run: |
          mkdir -p taipei new_taipei taoyuan taichung tainan kaohsiung

      - name: Install jq
        run: sudo apt-get install -y jq

      ################################################################
      # Taipei
      ################################################################
      - name: Fetch Taipei
        run: |
          echo "Fetching Taipei…"
          if curl -L "https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_allavailable.json" -o taipei/tmp.json; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' taipei/tmp.json > taipei/parking.json
          else
            echo "Taipei API FAILED — using fallback"
            cp taipei/parking.json taipei/parking_backup.json 2>/dev/null || true
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' taipei/parking.json > taipei/tmp2.json
            mv taipei/tmp2.json taipei/parking.json
          fi

      ################################################################
      # New Taipei
      ################################################################
      - name: Fetch New Taipei
        run: |
          echo "Fetching New Taipei…"
          if curl -L "https://data.ntpc.gov.tw/api/datasets/71C63833-3709-44B1-9F48-19E7AC5C37D5/json" -o new_taipei/tmp.json; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' new_taipei/tmp.json > new_taipei/parking.json
          else
            echo "New Taipei API FAILED — using fallback"
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' new_taipei/parking.json > new_taipei/tmp2.json
            mv new_taipei/tmp2.json new_taipei/parking.json
          fi

      ################################################################
      # Taoyuan
      ################################################################
      - name: Fetch Taoyuan
        run: |
          echo "Fetching Taoyuan…"
          if curl -L "https://data.tycg.gov.tw/opendata/datalist/datasetMeta/download?id=cfb25f39-5310-4ad0-8a07-8b9bb8422d5b&rid=75f883aa-c771-417a-9a89-48d5575e90c9" -o taoyuan/tmp.json; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' taoyuan/tmp.json > taoyuan/parking.json
          else
            echo "Taoyuan API FAILED — using fallback"
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' taoyuan/parking.json > taoyuan/tmp2.json
            mv taoyuan/tmp2.json taoyuan/parking.json
          fi

      ################################################################
      # Taichung
      ################################################################
      - name: Fetch Taichung
        run: |
          echo "Fetching Taichung…"
          if curl -L "https://datacenter.taichung.gov.tw/swagger/OpenData/136800000A-000589-001" -o taichung/tmp.json; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' taichung/tmp.json > taichung/parking.json
          else
            echo "Taichung API FAILED — using fallback"
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' taichung/parking.json > taichung/tmp2.json
            mv taichung/tmp2.json taichung/parking.json
          fi

      ################################################################
      # Tainan
      ################################################################
      - name: Fetch Tainan
        run: |
          echo "Fetching Tainan…"
          if curl -L "https://parking.tainan.gov.tw/OpenData/OffStreetParking.json" -o tainan/tmp.json; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' tainan/tmp.json > tainan/parking.json
          else
            echo "Tainan API FAILED — using fallback"
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' tainan/parking.json > tainan/tmp2.json
            mv tainan/tmp2.json tainan/parking.json
          fi

      ################################################################
      # Kaohsiung
      ################################################################
      - name: Fetch Kaohsiung
        run: |
          echo "Fetching Kaohsiung…"
          if curl -L "https://api.kcg.gov.tw/api/service/get/9c087def-f5f9-43d7-aed6-d37ffdc9fd21" -o kaohsiung/tmp.json; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' kaohsiung/tmp.json > kaohsiung/parking.json
          else
            echo "Kaohsiung API FAILED — using fallback"
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' kaohsiung/parking.json > kaohsiung/tmp2.json
            mv kaohsiung/tmp2.json kaohsiung/parking.json
          fi

      ################################################################
      # Commit & Push
      ################################################################
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "update parking data" || echo "Nothing to commit"
          git push
