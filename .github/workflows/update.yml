name: Update Taiwan Parking Data

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # æ¯ 6 å°æ™‚æ›´æ–°ä¸€æ¬¡

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Create folders
        run: |
          mkdir -p taipei new_taipei taoyuan taichung tainan kaohsiung

      ################################################################
      # ðŸ”µ å°åŒ— â€” JSON APIï¼ˆç©©å®šï¼‰
      ################################################################
      - name: Taipei
        run: |
          URL="https://tcgbusfs.blob.core.windows.net/blobtcmsv/TCMSV_alldesc.json"
          FILE="taipei/parking.json"

          curl -L "$URL" -o tmp.json || true

          if cat tmp.json | jq empty > /dev/null 2>&1; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' tmp.json > "$FILE"
          else
            echo 'API error, keeping fallback'
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' "$FILE" > tmp2.json || true
            mv tmp2.json "$FILE" || true
          fi

      ################################################################
      # ðŸŸ¡ æ–°åŒ— â€” æœ‰æ™‚æœƒå£ž/æ ¼å¼æ€ª
      ################################################################
      - name: New Taipei
        run: |
          URL="https://data.ntpc.gov.tw/api/datasets/71C63833-3709-44B1-9F48-19E7AC5C37D5/json"
          FILE="new_taipei/parking.json"

          curl -L "$URL" -o tmp.json || true

          if cat tmp.json | jq empty > /dev/null 2>&1; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' tmp.json > "$FILE"
          else
            echo 'New Taipei API not JSON, fallback'
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' "$FILE" > tmp2.json || true
            mv tmp2.json "$FILE" || true
          fi

      ################################################################
      # ðŸŸ  æ¡ƒåœ’ â€” å¶çˆ¾ SSL/é€£ä¸é€š
      ################################################################
      - name: Taoyuan
        run: |
          URL="https://data.tycg.gov.tw/opendata/datalist/datasetMeta/download?id=cfb2f59a-5310-4a0d-8a07-89bb8422d58b&rid=7f5883aa-c771-417a-9a89-48d5575e90c0"
          FILE="taoyuan/parking.json"

          curl -L "$URL" -o tmp.json || true

          if cat tmp.json | jq empty > /dev/null 2>&1; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' tmp.json > "$FILE"
          else
            echo 'Tycg API failed, fallback'
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' "$FILE" > tmp2.json || true
            mv tmp2.json "$FILE" || true
          fi

      ################################################################
      # ðŸ”´ å°ä¸­
      ################################################################
      - name: Taichung
        run: |
          URL="https://datacenter.taichung.gov.tw/swagger/OpenData/fb457b2d-df7e-48fb-a66f-ef3b725f0c15"
          FILE="taichung/parking.json"

          curl -L "$URL" -o tmp.json || true

          if cat tmp.json | jq empty > /dev/null 2>&1; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' tmp.json > "$FILE"
          else
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' "$FILE" > tmp2.json || true
            mv tmp2.json "$FILE" || true
          fi

      ################################################################
      # ðŸŸ£ å°å— â€” å¸¸å¸¸ DNS/SSL å•é¡Œ
      ################################################################
      - name: Tainan
        run: |
          URL="https://api.tainan.gov.tw/parking/v1/OffStreet/CarPark"
          FILE="tainan/parking.json"

          curl -L "$URL" -o tmp.json || true

          if cat tmp.json | jq empty > /dev/null 2>&1; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' tmp.json > "$FILE"
          else
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' "$FILE" > tmp2.json || true
            mv tmp2.json "$FILE" || true
          fi

      ################################################################
      # ðŸŸ¢ é«˜é›„
      ################################################################
      - name: Kaohsiung
        run: |
          URL="https://api.kcg.gov.tw/api/service/Get/75dfc8f6-4b31-4dbf-bdb4-4a37f1319304"
          FILE="kaohsiung/parking.json"

          curl -L "$URL" -o tmp.json || true

          if cat tmp.json | jq empty > /dev/null 2>&1; then
            jq '. + {updated_at: now|tojson , source_status:"live"}' tmp.json > "$FILE"
          else
            jq '. + {updated_at: now|tojson , source_status:"fallback"}' "$FILE" > tmp2.json || true
            mv tmp2.json "$FILE" || true
          fi

      ################################################################
      # ðŸ“Œ Commit updates
      ################################################################
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Auto update parking data $(date '+%Y-%m-%d %H:%M:%S')" || true
          git push
